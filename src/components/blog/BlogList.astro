---
import BlogPost from './BlogPost.astro';
import type { CollectionEntry } from 'astro:content';
import { categories } from '../../data/categories';
import { getCollection } from 'astro:content';

interface Props {
  posts: CollectionEntry<'blog'>[];
  currentCategory?: string;
}

const { posts, currentCategory } = Astro.props;

const allPosts = await getCollection('blog', ({ data }) => {
  return import.meta.env.DEV || data.publish !== false;
});

const activeCategories = categories.filter((category) =>
  allPosts.some((post) => post.data.categories?.includes(category.name)),
);
---

<section class="site-container mx-auto px-4 py-base text-[var(--color-body)]">
  <div
    class="mb-16 flex flex-col sm:flex-row sm:justify-between sm:items-end gap-8"
    data-aos="fade-in"
    data-aos-delay="100"
  >
    <div class="w-full">
      <h4 class="text-xl font-semibold tracking-tight text-[var(--color-headline)] mb-4">
        Filter by tag:
      </h4>

      <div class="flex flex-wrap gap-3 items-center">
        <a
          href="/blog"
          class:list={[
            'px-4 py-2 text-sm rounded-full border transition-all',
            'motion-safe:hover:scale-105 motion-safe:hover:shadow-elevated hover-glow motion-safe:hover:border-[var(--color-primary)] motion-safe:hover:text-[var(--color-primary)]',
            !currentCategory
              ? 'bg-primary text-white dark:text-black font-semibold'
              : 'border-[var(--color-border)] text-[var(--color-body-base)] hover:bg-[var(--color-surface-2)]'
          ]}
        >
          Show All
        </a>

        {activeCategories.map((category) => (
          <a
            href={`/category/${category.slug}`}
            title={category.description}
            class:list={[
              'px-4 py-2 text-sm rounded-full border transition-all',
              'motion-safe:hover:scale-105 motion-safe:hover:shadow-elevated hover-glow motion-safe:hover:border-[var(--color-primary)] motion-safe:hover:text-[var(--color-primary)]',
              currentCategory === category.slug
                ? 'bg-primary text-white dark:text-black font-semibold'
                : 'border-[var(--color-border)] text-[var(--color-body-base)] hover:bg-[var(--color-surface-2)]'
            ]}
          >
            {category.name}
          </a>
        ))}
      </div>
    </div>

    <p class="text-sm text-[var(--color-body-light)] text-left sm:text-right whitespace-nowrap">
      Showing <span class="font-semibold text-primary">{posts.length}</span> of
      <span class="font-semibold text-primary"> {allPosts.length}</span> posts
    </p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" data-aos="fade-up">
    {posts.map((post, index) => (
      <div>
        <BlogPost
          title={post.data.title}
          excerpt={post.data.excerpt}
          featuredImage={post.data.featuredImage || ''}
          publishDate={post.data.publishDate}
          categories={post.data.categories || []}
          slug={post.id}
          index={index}
        />
      </div>
    ))}
  </div>

  {posts.length === 0 && (
    <p class="text-center text-[var(--color-body-light)] py-8 italic">
      No posts found in this category.
    </p>
  )}
</section>
